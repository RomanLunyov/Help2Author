from aiogram import Router
from aiogram.filters import CommandStart, Command
from aiogram.types import Message
from aiogram.fsm.context import FSMContext

from database import Database
from keyboards import get_main_menu
import config

router = Router()
db = Database()


@router.message(CommandStart())
async def cmd_start(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await state.clear()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
    await db.add_user(message.from_user.id, message.from_user.username)
    
    welcome_text = (
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∫–Ω–∏–≥!\n\n"
        "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"
        "üìò –ü—Ä–æ–¥–∞—Ç—å —Å–≤–æ–∏ –∫–Ω–∏–≥–∏ –∏ –ø–æ–º–æ—á—å –¥—Ä—É–≥–∏–º –∞–≤—Ç–æ—Ä–∞–º\n"
        "üÜì –†–µ–∫–ª–∞–º–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∫–Ω–∏–≥–∏\n"
        "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é –∫–Ω–∏–≥—É –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è\n"
        "üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–≤–æ–µ–π –∫–Ω–∏–≥–∏\n\n"
        "–ö–∞–∂–¥–æ–µ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ (–ø–æ–∫—É–ø–∫–∞, –æ—Ü–µ–Ω–∫–∞, –æ—Ç–∑—ã–≤) –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–¥–≤–∏–≥–∞—Ç—å –≤–∞—à—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –∫–Ω–∏–≥—É! "
        "–ù–∞–ø—Ä–∏–º–µ—Ä, –í—ã –∫—É–ø–∏–ª–∏ 1 —á—å—é-—Ç–æ –∫–Ω–∏–≥—É, –í–∞—à—É –∫–Ω–∏–≥—É –∫—É–ø—è—Ç 5 —á–µ–ª–æ–≤–µ–∫, –Ω–∞–ø–∏—Å–∞–ª–∏ 1 –æ—Ç–∑—ã–≤, –í–∞—à–µ–π –∫–Ω–∏–≥–µ –Ω–∞–ø–∏—à—É—Ç 5 –æ—Ç–∑—ã–≤–æ–≤ –¥—Ä—É–≥–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏. –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–∞—é—Ç –í–∞–º –ø–æ–ª—å–∑—É –≤ 5 —Ä–∞–∑ –±–æ–ª—å—à–µ!\n\n"
        "–ß–µ–º –±–æ–ª—å—à–µ –≤—ã –ø–æ–º–æ–≥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º –∞–≤—Ç–æ—Ä–∞–º, —Ç–µ–º –±–æ–ª—å—à–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—É—á–∞–µ—Ç –≤–∞—à–∞ –∫–Ω–∏–≥–∞.\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –Ω–∏–∂–µ üëá"
    )
    
    await message.answer(welcome_text, reply_markup=get_main_menu())


@router.message(Command("help"))
async def cmd_help(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = (
        "‚ÑπÔ∏è <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–æ—Ç:</b>\n\n"
        "<b>1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∏:</b>\n"
        "‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–Ω–∏–≥–∏ (–ø–ª–∞—Ç–Ω–∞—è/–±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)\n"
        "‚Ä¢ –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Å—Å—ã–ª–∫—É –∏ —Ü–µ–Ω—É (–¥–ª—è –ø–ª–∞—Ç–Ω—ã—Ö)\n"
        "‚Ä¢ –í–∞—à–∞ –∫–Ω–∏–≥–∞ –ø–æ–ø–∞–¥—ë—Ç –≤ –æ—á–µ—Ä–µ–¥—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è\n\n"
        "<b>2. –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ:</b>\n"
        "‚Ä¢ –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è 5 –∫–Ω–∏–≥ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞\n"
        f"‚Ä¢ –ö–Ω–∏–≥–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Ä–µ–∫–ª–∞–º—ã, –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∏—Ç {config.ACTIONS_REQUIRED} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π. –î–ª—è –ø–ª–∞—Ç–Ω—ã—Ö –∫–Ω–∏–≥: –í–∞—à—É –∫–Ω–∏–≥—É –∫—É–ø—è—Ç 5 —á–µ–ª–æ–≤–µ–∫, –≤ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ: –í—ã –ø–æ–ª—É—á–∏—Ç–µ 5 –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤\n"
        "‚Ä¢ –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–∫–ª–∞–º—ã, –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –∫–Ω–∏–≥—É\n\n"
        "<b>3. –ü–æ–º–æ—â—å –¥—Ä—É–≥–∏–º –∞–≤—Ç–æ—Ä–∞–º:</b>\n"
        "‚Ä¢ –ü–æ–∫—É–ø–∞–π—Ç–µ –ø–ª–∞—Ç–Ω—ã–µ –∫–Ω–∏–≥–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç\n"
        "‚Ä¢ –°—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫–∏, –ø–∏—à–∏—Ç–µ –æ—Ç–∑—ã–≤—ã, –ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –Ω–∞ –∞–≤—Ç–æ—Ä–æ–≤\n"
        "‚Ä¢ –ö–∞–∂–¥–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–∑–≤–æ–ª–∏—Ç –í–∞–º –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ—é –∫–Ω–∏–≥—É, –∏ –æ–Ω–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –µ—ë –±—É–¥—É—Ç –ø–æ–∫—É–ø–∞—Ç—å, –ø–∏—Å–∞—Ç—å –æ—Ç–∑—ã–≤—ã –∏ —Å—Ç–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫–∏\n\n"
        "<b>4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π:</b>\n"
        "‚Ä¢ –ê–≤—Ç–æ—Ä –∫–Ω–∏–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ç–µ—á–µ–Ω–∏–µ 12 —á–∞—Å–æ–≤\n"
        "‚Ä¢ –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏\n\n"
        "<b>5. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:</b>\n"
        "‚Ä¢ –ó–∞ –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–º–æ—â—å –¥—Ä—É–≥–∏–º –∞–≤—Ç–æ—Ä–∞–º, –≤–∞—à–∞ –∫–Ω–∏–≥–∞ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ –±—ã—Å—Ç—Ä–µ–µ\n\n"
        "–ß–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ –≤—ã –ø–æ–º–æ–≥–∞–µ—Ç–µ –¥—Ä—É–≥–∏–º, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –≤–∞—à–∞ –∫–Ω–∏–≥–∞ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–µ–∫–ª–∞–º–µ, –ø–æ–ª—É—á–∏—Ç –±–æ–ª—å—à–µ –æ—Ç–∑—ã–≤–æ–≤, –æ—Ü–µ–Ω–æ–∫ –∏ –ø–æ–∫—É–ø–æ–∫! üöÄ"
    )
    
    await message.answer(help_text, parse_mode="HTML")


@router.message(lambda message: message.text == "‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç")
async def how_it_works(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç'"""
    await cmd_help(message)


@router.message(lambda message: message.text == "üí¨ –û—Ç–∑—ã–≤—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è")
async def feedback_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–û—Ç–∑—ã–≤—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è'"""
    text = (
        "üí¨ <b>–û—Ç–∑—ã–≤—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</b>\n\n"
        f"–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –Ω–∞—à–µ–º—É —á–∞—Ç—É –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞, "
        f"–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ –æ–±—â–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∞–≤—Ç–æ—Ä–∞–º–∏:\n\n"
        f"üëâ {config.FEEDBACK_CHAT_LINK}\n\n"
        f"–ë—É–¥–µ–º —Ä–∞–¥—ã –≤–∞—à–∏–º –æ—Ç–∑—ã–≤–∞–º –∏ –∏–¥–µ—è–º –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–µ–∫—Ç–∞!"
    )
    
    await message.answer(text, parse_mode="HTML")
