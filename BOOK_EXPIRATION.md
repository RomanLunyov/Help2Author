# Функция автоматического удаления просроченных книг

## Описание
Добавлен функционал автоматического удаления платных книг из раздела рекомендаций, если они не набрали требуемое количество действий (5 покупок) в течение 30 дней.

## Как это работает

### 1. Отслеживание времени
- При переходе книги в статус "in_recommendations" (попадание в топ-5), записывается время начала рекомендаций в поле `recommendations_started_at`
- Если книга выходит из рекомендаций и потом возвращается, время сохраняется

### 2. Автоматическая проверка
- Планировщик (scheduler) каждые **6 часов** проверяет все платные книги в рекомендациях
- Находит книги, которые:
  - Находятся в статусе "in_recommendations"
  - Имеют тип "paid" (платные)
  - Не набрали 5 действий (`confirmed_actions < 5`)
  - Находятся в рекомендациях более 30 дней

### 3. Процесс удаления
При обнаружении просроченной книги:
1. Удаляются все связанные действия пользователей (`user_actions`)
2. Удаляется сама книга из таблицы `books`
3. Пересчитываются позиции в очереди для остальных книг
4. Обновляются статусы рекомендаций - следующая книга из очереди автоматически занимает освободившееся место

### 4. Логирование
Все удаления записываются в лог с указанием:
- Времени удаления
- Названия книги
- ID книги
- Причины удаления

## Настройки

В файле `config.py`:
```python
BOOK_EXPIRATION_DAYS = 30  # Дней до автоматического удаления книги из рекомендаций
```

Вы можете изменить это значение на любое другое количество дней.

## Технические детали

### Новое поле в базе данных
```sql
ALTER TABLE books 
ADD COLUMN recommendations_started_at TIMESTAMP;
```

### Планировщик
В `scheduler.py` добавлена задача:
```python
scheduler.add_job(
    remove_expired_paid_books,
    'interval',
    hours=6,
    id='remove_expired',
    replace_existing=True
)
```

### Метод в Database
```python
async def auto_remove_expired_books(self) -> int:
    """Автоматически удалить платные книги, которые не набрали 5 действий за 30 дней"""
```

## Тестирование

Для тестирования функции запустите:
```bash
python test_expiration.py
```

Этот скрипт покажет:
- Все книги до проверки
- Количество удалённых книг
- Все книги после проверки

## Важные замечания

1. **Только платные книги**: Функция затрагивает только платные книги (`book_type = 'paid'`)
2. **Только в рекомендациях**: Удаляются только книги со статусом "in_recommendations"
3. **Автоматическая замена**: После удаления следующая книга из очереди автоматически попадает в рекомендации
4. **Без уведомлений**: В текущей версии авторы не получают уведомления об удалении (можно добавить отдельно)
